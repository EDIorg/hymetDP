<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hymetDP">
<title>Create hymetDP Data • hymetDP</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Create hymetDP Data">
<meta property="og:description" content="hymetDP">
<meta property="og:image" content="https://kzollove.github.io/hymetDP/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-default navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hymetDP</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/create.html">Create</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/kzollove/hymetDP/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Create hymetDP Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kzollove/hymetDP/blob/HEAD/vignettes/create.Rmd" class="external-link"><code>vignettes/create.Rmd</code></a></small>
      <div class="d-none name"><code>create.Rmd</code></div>
    </div>

    
    
<p>Ideally, each hymetDP dataset (Level-1; L1) is created from a source dataset (Level-0; L0) by a unique processing function. Inputs are typically from the APIs of data repositories and monitoring networks, and outputs can be a list of R objects or a set of archivable files. The output form you choose may depend on multiple factors including the source data license (it may prohibit archive) and the overall processing time (on-demand processing may be prohibitively long). In either case, the derived hymetDP dataset is delivered to users in a consistent format by <code><a href="../reference/read_data.html">read_data()</a></code> and the processing function provides a fully reproducible and automated routine for updating the derived dataset whenever a new version of the source data are released.</p>
<p>Below is an example function that reads a source dataset from the Environmental Data Initiative (EDI) repository and converts it into a hymetDP dataset, which in turn is archived in EDI. For an example of creating a hymetDP dataset on-demand (i.e. not archived), see the create_USGS_hymet.R source code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kzollove/hymetDP" class="external-link">hymetDP</a></span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="for-archive-in-a-data-repository">For archive in a data repository<a class="anchor" aria-label="anchor" href="#for-archive-in-a-data-repository"></a>
</h2>
<div class="section level4">
<h4 id="example-function">Example function:<a class="anchor" aria-label="anchor" href="#example-function"></a>
</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># -----------------------------------------------------------------------------</span>
<span class="co"># This function converts source dataset "knb-lter-mcm.9003" (archived in the EDI</span>
<span class="co"># Data Repository) to hymetDP dataset "edi.10101"</span>
<span class="co"># </span>
<span class="co"># Arguments:</span>
<span class="co">#</span>
<span class="co"># path        Where the hymetDP tables will be written</span>
<span class="co"># source_id   Identifier of the source dataset</span>
<span class="co"># derived_id  Identifier of the derived dataset</span>
<span class="co"># url         The URL by which the derived tables and metadata can be accessed </span>
<span class="co">#             by a data repository. This argument is used when automating the </span>
<span class="co">#             repository publication step, but not used when manually </span>
<span class="co">#             publishing.</span>
<span class="co">#</span>
<span class="co"># Value:</span>
<span class="co">#</span>
<span class="co"># tables      (.csv) hymetDP tables</span>
<span class="co"># metadata    (.xml) EML metadata for tables</span>
<span class="co"># </span>
<span class="co"># Details:</span>
<span class="co">#             This function facilitates automated updates to the derived </span>
<span class="co">#             "edi.10101" whenever new data are added to the source </span>
<span class="co">#             "knb-lter-mcm.9003". The framework executing this maintenance </span>
<span class="co">#             routine is hosted on a remote server and jumps into action </span>
<span class="co">#             whenever an update notification is received for </span>
<span class="co">#             "knb-lter-mcm.9003". The maintenance routine parses the </span>
<span class="co">#             notification to get the arguments to create_hymetDP().</span>
<span class="co">#</span>
<span class="co"># Landing page to source dataset "knb-lter-mcm.9003":</span>
<span class="co"># https://portal.edirepository.org/nis/mapbrowse?scope=knb-lter-mcm&amp;identifier=9003</span>
<span class="co"># Landing page to derived dataset "edi.10101":</span>
<span class="co"># https://portal.edirepository.org/nis/mapbrowse?scope=edi&amp;identifier=10101</span>
<span class="co"># -----------------------------------------------------------------------------</span>
<span class="co"># Libraries used by this function</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kzollove/hymetDP" class="external-link">hymetDP</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/EDIutils" class="external-link">EDIutils</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/" class="external-link">xml2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://andyteucher.ca/lutz" class="external-link">lutz</a></span><span class="op">)</span>

<span class="va">create_hymetDP</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span> <span class="op">=</span> <span class="cn">NULL</span>,
                                 <span class="va">source_id</span> <span class="op">=</span> <span class="st">'knb-lter-mcm.9003.11'</span>,
                                 <span class="va">derived_id</span> <span class="op">=</span> <span class="st">'edi.10101.1'</span>,
                                 <span class="va">url</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># Read source dataset -------------------------------------------------</span>

  <span class="co"># The source dataset contains seasonal high-frequency measurements of</span>
  <span class="co"># discharge, water temperature, and specific conductivity from a site in</span>
  <span class="co"># Antarctica. The dataset consists of a data table containing internal codes,</span>
  <span class="co"># datetimes, measurements, meaurement quality flags, and general comments. </span>
  <span class="co"># Once the table is read in using the `read_tables()`, any missing values </span>
  <span class="co"># will automatically be converted to `NA`, and columns for units will be added</span>
  
  <span class="va">eml</span> <span class="op">&lt;-</span> <span class="fu">EDIutils</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/EDIutils/reference/read_metadata.html" class="external-link">read_metadata</a></span><span class="op">(</span><span class="va">source_id</span><span class="op">)</span>

  <span class="va">tables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_tables.html">read_tables</a></span><span class="op">(</span>
    eml <span class="op">=</span> <span class="va">eml</span>,
    strip.white <span class="op">=</span> <span class="cn">TRUE</span>,
    na.strings <span class="op">=</span> <span class="st">""</span>,
    convert.missing.value <span class="op">=</span> <span class="cn">TRUE</span>,
    add.units <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

  <span class="co"># Join and flatten the source dataset ---------------------------------------</span>

  <span class="co"># Joining all source data and relevant metadata into one big flat table </span>
  <span class="co"># simplifies parsing into hymetDP tables and facilitates referential </span>
  <span class="co"># integrity in the process.</span>
  <span class="co">#</span>
  <span class="co"># The first step towards creating our "flat" table is to create a wide table</span>
  <span class="co"># that consists of all relevant tables from the dataset. Since our dataset</span>
  <span class="co"># only contains a single table, nothing special needs to happen to create the</span>
  <span class="co"># preliminary wide table</span>
  
  <span class="va">wide</span> <span class="op">&lt;-</span> <span class="va">tables</span><span class="op">$</span><span class="va">`mcmlter-strm-h1_andersen-15min-20210303.csv`</span>
  
  <span class="co"># Before we transform our "wide" table into a "flat" table, we should add a</span>
  <span class="co"># few columns, drop the ones we won't need, and make a few other changes that</span>
  <span class="co"># are easier to implement to the wide table:</span>

  <span class="co"># Specify timezone/offset</span>
  
  <span class="co"># Convert the datetime column to the ISO-8601 format, assign the timezone and</span>
  <span class="co"># UTCoffset, and create the hymetDP required date columns</span>

  <span class="va">wide</span><span class="op">$</span><span class="va">LocalDateTime</span> <span class="op">&lt;-</span> <span class="va">wide</span><span class="op">$</span><span class="va">DATE_TIME</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/strptime.html" class="external-link">strptime</a></span><span class="op">(</span>format <span class="op">=</span> <span class="st">"%m/%d/%y %H:%M"</span>, tz <span class="op">=</span> <span class="st">"Antarctica/McMurdo"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_datetime</a></span><span class="op">(</span>tz <span class="op">=</span> <span class="st">"Antarctica/McMurdo"</span><span class="op">)</span>

  <span class="va">wide</span><span class="op">$</span><span class="va">UTCOffset</span> <span class="op">&lt;-</span> <span class="fu">lutz</span><span class="fu">::</span><span class="fu"><a href="https://andyteucher.ca/lutz/reference/tz_offset.html" class="external-link">tz_offset</a></span><span class="op">(</span><span class="va">wide</span><span class="op">$</span><span class="va">LocalDateTime</span>, <span class="st">"Antarctica/McMurdo"</span><span class="op">)</span><span class="op">$</span><span class="va">utc_offset_h</span>

  <span class="va">wide</span><span class="op">$</span><span class="va">DateTimeUTC</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/with_tz.html" class="external-link">with_tz</a></span><span class="op">(</span><span class="va">wide</span><span class="op">$</span><span class="va">LocalDateTime</span>, <span class="st">"Etc/UTC"</span><span class="op">)</span>

  <span class="co"># Remove columns that will not be used in the final hymetDP tables</span>
  
  <span class="va">wide</span> <span class="op">&lt;-</span> <span class="va">wide</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>
      <span class="op">-</span><span class="va">DATASET_CODE</span>,
      <span class="op">-</span><span class="va">STRMGAGEID</span>,
      <span class="op">-</span><span class="va">DATE_TIME</span>,
      <span class="op">-</span><span class="va">COMMENTS</span><span class="op">)</span>
  
  <span class="co"># Flatten ----------------------------------------------------------------</span>

  <span class="co"># Convert wide format to "flat" format. This is the wide form but gathered on </span>
  <span class="co"># core observation variables, which are often &gt; 1 in source datasets. This </span>
  <span class="co"># "flat" table is the "widest" hymetDP datasets can be consistently returned </span>
  <span class="co"># to by the hymetDP::flatten_data() function, and is the input format </span>
  <span class="co"># required by the "create table" helpers we'll meet shortly.</span>
  <span class="co">#</span>
  <span class="co"># To make the transition from wide to flat, we need to rename columns to</span>
  <span class="co"># follow the scheme "columnType.columnValue". The unique columnTypes will</span>
  <span class="co"># become the names of new columns containing the columnValues. The</span>
  <span class="co"># columnValues will in turn be associated with their original values in the</span>
  <span class="co"># value column.</span>
  
  <span class="va">wide</span> <span class="op">&lt;-</span> <span class="va">wide</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename_with</a></span><span class="op">(</span>
      <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"DataValue."</span>, <span class="va">.</span><span class="op">)</span>,
      .cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DSCHRGE_RATE"</span>,<span class="st">"WATER_TEMP"</span>,<span class="st">"CONDUCTIVITY"</span><span class="op">)</span><span class="op">)</span>

  <span class="va">wide</span> <span class="op">&lt;-</span> <span class="va">wide</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>
      Qualifier.DSCHRGE_RATE <span class="op">=</span> <span class="va">DSCHRGE_QLTY</span>,
      Qualifier.WATER_TEMP <span class="op">=</span> <span class="va">WATER_TEMP_QLTY</span>,
      Qualifier.CONDUCTIVITY <span class="op">=</span> <span class="va">CONDUCTIVITY_QLTY</span>,
      unit.DSCHRGE_RATE <span class="op">=</span> <span class="va">unit_DSCHRGE_RATE</span>,
      unit.WATER_TEMP <span class="op">=</span> <span class="va">unit_WATER_TEMP</span>,
      unit.CONDUCTIVITY <span class="op">=</span> <span class="va">unit_CONDUCTIVITY</span><span class="op">)</span>

  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>
    <span class="va">wide</span>,
    cols <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DSCHRGE"</span>, <span class="st">"WATER_TEMP"</span>, <span class="st">"CONDUCTIVITY"</span><span class="op">)</span><span class="op">)</span>,
    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".value"</span>, <span class="st">"variable_name"</span><span class="op">)</span>,
    names_sep <span class="op">=</span> <span class="st">"\\."</span><span class="op">)</span>

  <span class="co"># We're now in a good place to begin adding columns of the hymetDP tables we</span>
  <span class="co"># can create from this source dataset. We'll begin with the DataValues table.</span>
  
  <span class="co"># Add columns for the data values table -----------------------------------</span>

  <span class="co"># Every row of the flat table represents a single data value in the hymetDP</span>
  <span class="co"># model. We assign a unique, integer ValueID to every entry:</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">ValueID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">flat</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># Assign variable code, define variable code function ---------------------</span>

  <span class="co"># We need to create the entries for the Variables table. These will be added</span>
  <span class="co"># as columns to the flat table. To do this, we can take advantage of</span>
  <span class="co"># `define_variable()`, which gives us a convenient way to specify a variable</span>
  <span class="co"># by its name as it is listed in the flat table (i.e. "DSCHRGE_RATE").</span>
  <span class="co">#</span>
  <span class="co"># By specifying that we are working with the values "DSCHRGE_RATE" in the </span>
  <span class="co"># column "variable_name" from the flat table, `define_variable()` will</span>
  <span class="co"># handle assigning unique VariableCodes and joining the provided information</span>
  <span class="co"># to its correct place in the flat table. </span>
  <span class="co">#</span>
  <span class="co"># For fields that require an ODM Controlled Vocabulary term, use the *CV</span>
  <span class="co"># objects to find fitting terms. If a non-supported term is given, </span>
  <span class="co"># `define_variable()` will throw a warning (and occasionally a hint).</span>
  
  <span class="co"># Define variables using the ODM Controlled vocabularies</span>

  <span class="co"># View(VariableNameCV)              # variable_name</span>
  <span class="co"># View(UnitsCV)                     # variable_units and time_units</span>
  <span class="co"># View(SampleMediumCV)              # sample_medium</span>
  <span class="co"># View(ValueTypeCV)                 # value_type</span>
  <span class="co"># View(DataTypeCV)                  # data_type</span>
  <span class="co"># View(GeneralCategoryCV)           # general_category</span>

  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/define_variable.html">define_variable</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    local_variable_column <span class="op">=</span> <span class="st">"variable_name"</span>,
    local_variable <span class="op">=</span> <span class="st">"DSCHRGE_RATE"</span>,
    variable_name <span class="op">=</span> <span class="st">"Discharge"</span>,
    variable_units <span class="op">=</span> <span class="st">"liters per second"</span>,
    sample_medium <span class="op">=</span> <span class="st">"Surface water"</span>,
    value_type <span class="op">=</span> <span class="st">"Derived Value"</span>,
    is_regular <span class="op">=</span> <span class="cn">TRUE</span>,
    time_support <span class="op">=</span> <span class="fl">15</span>,
    time_units <span class="op">=</span> <span class="st">"minute"</span>,
    data_type <span class="op">=</span> <span class="st">"Continuous"</span>,
    general_category <span class="op">=</span> <span class="st">"Hydrology"</span>,
    no_data <span class="op">=</span> <span class="op">-</span><span class="fl">9999</span><span class="op">)</span>

  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/define_variable.html">define_variable</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    local_variable_column <span class="op">=</span> <span class="st">"variable_name"</span>,
    local_variable <span class="op">=</span> <span class="st">"WATER_TEMP"</span>,
    variable_name <span class="op">=</span> <span class="st">"Temperature"</span>,
    variable_units <span class="op">=</span> <span class="st">"degree celsius"</span>,
    sample_medium <span class="op">=</span> <span class="st">"Surface water"</span>,
    value_type <span class="op">=</span> <span class="st">"Field Observation"</span>,
    is_regular <span class="op">=</span> <span class="cn">TRUE</span>,
    time_support <span class="op">=</span> <span class="fl">15</span>,
    time_units <span class="op">=</span> <span class="st">"minute"</span>,
    data_type <span class="op">=</span> <span class="st">"Continuous"</span>,
    general_category <span class="op">=</span> <span class="st">"Hydrology"</span>,
    no_data <span class="op">=</span> <span class="op">-</span><span class="fl">9999</span><span class="op">)</span>

  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/define_variable.html">define_variable</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    local_variable_column <span class="op">=</span> <span class="st">"variable_name"</span>,
    local_variable <span class="op">=</span> <span class="st">"CONDUCTIVITY"</span>,
    variable_name <span class="op">=</span> <span class="st">"Specific conductance"</span>,
    variable_units <span class="op">=</span> <span class="st">"microsiemens per centimeter"</span>,
    sample_medium <span class="op">=</span> <span class="st">"Surface water"</span>,
    value_type <span class="op">=</span> <span class="st">"Field Observation"</span>,
    is_regular <span class="op">=</span> <span class="cn">TRUE</span>,
    time_support <span class="op">=</span> <span class="fl">15</span>,
    time_units <span class="op">=</span> <span class="st">"minute"</span>,
    data_type <span class="op">=</span> <span class="st">"Continuous"</span>,
    general_category <span class="op">=</span> <span class="st">"Hydrology"</span>,
    no_data <span class="op">=</span> <span class="op">-</span><span class="fl">9999</span><span class="op">)</span>

  <span class="co"># define_methods ---------------------------------------------------------</span>

  <span class="co"># Define methods and link to specific variables (by code or by name)</span>
  
  <span class="co"># Similar to `define_variable()`, there is a function for defining dataset</span>
  <span class="co"># methods. `define_method()` works under the assumption that each variable</span>
  <span class="co"># only has a single method associated with it. For this reason,</span>
  <span class="co"># `define_method()` lets you associate a MethodDescription to one or more </span>
  <span class="co"># variables in the flat table by specifying the original variable name (i.e.</span>
  <span class="co"># "DSCHRGE_RATE") or by the variable's newly assigned VariableCode. If both</span>
  <span class="co"># parameters are specified, the VariableCode will take precedence.</span>
  <span class="co">#</span>
  <span class="co"># `define_method()` is a straightforward helper function unless it is </span>
  <span class="co"># necessary to associate multiple methods with a single variable (i.e. methods</span>
  <span class="co"># change over time). When this is the case, a useful tactic can be to split </span>
  <span class="co"># the flat table in pieces and running `define_method()` on the fragments,</span>
  <span class="co"># taking care to re-join the flat fragments and manually assign MethodCodes.</span>

  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/define_method.html">define_method</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    local_variable_column <span class="op">=</span> <span class="st">"variable_name"</span>,
    local_variable <span class="op">=</span> <span class="st">"DSCHRGE_RATE"</span>,
    VariableCode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>,
    MethodDescription <span class="op">=</span> <span class="st">[2868 chars quoted with '"']</span>,
    MethodLink <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>

  <span class="co"># Add columns for the sites table -----------------------------------</span>

  <span class="co"># Ideally, for datasets with multiple Sites, the source dataset would include</span>
  <span class="co"># latitude, longitude, and elevation for each Site. Since this dataset only</span>
  <span class="co"># has a single site, we only need to extract the single coordinate from the</span>
  <span class="co"># metadata.</span>
  
  <span class="va">geo_cov</span> <span class="op">&lt;-</span> <span class="va">eml</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="st">'.//geographicCoverage'</span><span class="op">)</span>

  <span class="va">site_name</span> <span class="op">&lt;-</span> <span class="va">geo_cov</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="st">'.//geographicDescription'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace_all</a></span><span class="op">(</span><span class="st">'\\n'</span>, <span class="st">''</span><span class="op">)</span>

  <span class="va">bounds</span> <span class="op">&lt;-</span> <span class="va">geo_cov</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="st">'.//boundingCoordinates'</span><span class="op">)</span>
  <span class="va">lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bounds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_double</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'.//westBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span>,
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_double</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'.//eastBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

  <span class="va">lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bounds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_double</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'.//northBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span>,
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_double</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'.//southBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>


  <span class="va">elev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bounds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_double</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'.//boundingAltitudes/altitudeMinimum'</span><span class="op">)</span><span class="op">)</span>,
      <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_double</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'.//boundingAltitudes/altitudeMaximum'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">elev</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_all</a></span><span class="op">(</span><span class="va">bounds</span>, <span class="st">'.//boundingAltitudes/altitudeUnits'</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'meter'</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Altitude must be converted to meter for hymetDP"</span><span class="op">)</span>

  <span class="co"># create a Sites table</span>
  
  <span class="co"># We can now add the geographic information, and other required columns for</span>
  <span class="co"># the Sites table, to our flat table. For the columns that require a CV term,</span>
  <span class="co"># use the *CV objects with `View()` as demonstrated below.</span>

  <span class="co"># View(SpatialReferencesCV) # LatLongDatumSRSName</span>
  <span class="co"># View(SiteTypeCV)          # SiteType</span>

  <span class="va">flat</span><span class="op">$</span><span class="va">SiteCode</span> <span class="op">&lt;-</span> <span class="fl">1</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">SiteName</span> <span class="op">&lt;-</span> <span class="va">site_name</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Latitude</span> <span class="op">&lt;-</span> <span class="va">lat</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Longitude</span> <span class="op">&lt;-</span> <span class="va">lon</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Elevation_m</span> <span class="op">&lt;-</span> <span class="va">elev</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">SiteType</span> <span class="op">&lt;-</span> <span class="st">"Stream"</span>

  <span class="co"># Add columns for the Sources table ---------------------------------------</span>

  <span class="co"># Some information for the Sources table must be manually added to the flat </span>
  <span class="co"># table. Other information, specifically, SourceDescription, SourceLink,</span>
  <span class="co"># Citation can be sourced automatically from the metadata.</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">Organization</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">eml</span>, <span class="st">'.//metadataProvider/organizationName'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">ContactName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">eml</span>, <span class="st">'.//contact/individualName/givenName'</span><span class="op">)</span><span class="op">)</span>, <span class="st">' '</span>,
                             <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">eml</span>, <span class="st">'.//contact/individualName/surName'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Email</span> <span class="op">&lt;-</span> <span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html" class="external-link">xml_text</a></span><span class="op">(</span><span class="fu">xml2</span><span class="fu">::</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html" class="external-link">xml_find_first</a></span><span class="op">(</span><span class="va">eml</span>, <span class="st">'.//contact/electronicMailAddress'</span><span class="op">)</span><span class="op">)</span>
  <span class="co"># flat$Address &lt;- xml2::xml_text(xml2::xml_find_first(eml, './/contact/address/deliveryPoint'))</span>
  <span class="co"># flat$City &lt;- xml2::xml_text(xml2::xml_find_first(eml, './/contact/address/city'))</span>
  <span class="co"># flat$State &lt;- xml2::xml_text(xml2::xml_find_first(eml, './/contact/address/administrativeArea'))</span>
  <span class="co"># flat$ZipCode &lt;- xml2::xml_text(xml2::xml_find_first(eml, './/contact/address/postalCode'))</span>

  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_source.html">define_source</a></span><span class="op">(</span>L0_flat <span class="op">=</span> <span class="va">flat</span>,
                        eml <span class="op">=</span> <span class="va">eml</span><span class="op">)</span>


  <span class="co"># Add columns for the Quality Control Level table ----------------------------------------</span>

  <span class="co"># Assign and describe Quality Control information for the dataset. In this</span>
  <span class="co"># case, all of the data is considered "Quality controlled data"</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">QualityControlLevelCode</span> <span class="op">&lt;-</span> <span class="fl">1</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Definition</span> <span class="op">&lt;-</span> <span class="st">"Quality controlled data"</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Explanation</span> <span class="op">&lt;-</span> <span class="st">"Quality controlled data that have passed quality assurance procedures such as routine estimation of timing and sensor calibration or visual inspection and removal of obvious errors. An example is USGS published streamflow records following parsing through USGS quality control procedures."</span>

  <span class="co"># Add columns for the optional tables -------------------------------------------</span>

  <span class="co"># Qualifiers</span>
  
  <span class="co"># Adding columns for the optional table Qualifiers using the information</span>
  <span class="co"># from the Qualifier column of the flat table</span>

  <span class="co"># Clean up the codes in the table</span>

  <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span> <span class="op">&lt;-</span> <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="op">)</span>

  <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"fair"</span>, <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span>, ignore.case<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"fair"</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span>, ignore.case<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"good"</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"poor"</span>, <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span>, ignore.case<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"poor"</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"[^fair|good|missing|poor]"</span>, <span class="va">flat</span><span class="op">$</span><span class="va">Qualifier</span>, ignore.case<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA_character_</span>


  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    <span class="va">flat</span>,
    QualifierCode <span class="op">=</span> <span class="va">Qualifier</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>
        <span class="st">"QualifierCode"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="st">"fair"</span>, <span class="st">"poor"</span>, <span class="st">"missing"</span><span class="op">)</span>,
        <span class="st">"QualifierDescription"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'most accurate within 10%'</span>,
                                   <span class="st">'most data accurate within 25%'</span>,
                                   <span class="st">'significant amounts of data may be &gt;25% off'</span>,
                                   <span class="st">"missing"</span><span class="op">)</span><span class="op">)</span>,
      by <span class="op">=</span> <span class="st">'QualifierCode'</span>
    <span class="op">)</span>

  <span class="co"># The hard work is done! The flat table contains all the source data and </span>
  <span class="co"># more! We can now use the "create" functions to parse this table into the </span>
  <span class="co"># hymetDP tables.</span>
  
  <span class="co"># Parse flat into hymetDP required tables -------------------------------------------</span>

  <span class="co"># Each hymetDP table has an associated "create" function. Begin with the </span>
  <span class="co"># core required tables.</span>
  
  <span class="va">Sources</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_sources.html">create_sources</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    SourceCode <span class="op">=</span> <span class="st">"SourceCode"</span>,
    Organization <span class="op">=</span> <span class="st">"Organization"</span>,
    SourceDescription <span class="op">=</span> <span class="st">"SourceDescription"</span>,
    SourceLink <span class="op">=</span> <span class="st">"SourceLink"</span>,
    ContactName <span class="op">=</span> <span class="st">"ContactName"</span>,
    Phone <span class="op">=</span> <span class="st">"Phone"</span>,
    Email <span class="op">=</span> <span class="st">"Email"</span>,
    Address <span class="op">=</span> <span class="st">"Address"</span>,
    City <span class="op">=</span> <span class="st">"City"</span>,
    State <span class="op">=</span> <span class="st">"State"</span>,
    ZipCode <span class="op">=</span> <span class="st">"ZipCode"</span>,
    Citation <span class="op">=</span> <span class="st">"Citation"</span><span class="op">)</span>
  
  <span class="va">Methods</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_methods.html">create_methods</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    MethodCode <span class="op">=</span> <span class="st">"MethodCode"</span>,
    MethodDescription <span class="op">=</span> <span class="st">"MethodDescription"</span><span class="op">)</span>
  
  <span class="va">Variables</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_variables.html">create_variables</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    VariableCode <span class="op">=</span> <span class="st">"VariableCode"</span>,
    VariableName <span class="op">=</span> <span class="st">"VariableName"</span>,
    VariableUnitsName <span class="op">=</span> <span class="st">"VariableUnitsName"</span>,
    SampleMedium <span class="op">=</span> <span class="st">"SampleMedium"</span>,
    ValueType <span class="op">=</span> <span class="st">"ValueType"</span>,
    IsRegular <span class="op">=</span> <span class="st">"IsRegular"</span>,
    TimeSupport <span class="op">=</span> <span class="st">"TimeSupport"</span>,
    TimeUnitsName <span class="op">=</span> <span class="st">"TimeUnitsName"</span>,
    DataType <span class="op">=</span> <span class="st">"DataType"</span>,
    GeneralCategory <span class="op">=</span> <span class="st">"GeneralCategory"</span>,
    NoDataValue <span class="op">=</span> <span class="st">"NoDataValue"</span><span class="op">)</span>
  
  <span class="va">Sites</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_sites.html">create_sites</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    SiteCode <span class="op">=</span> <span class="st">"SiteCode"</span>,
    SiteName <span class="op">=</span> <span class="st">"SiteName"</span>,
    Latitude <span class="op">=</span> <span class="st">"Latitude"</span>,
    Longitude <span class="op">=</span> <span class="st">"Longitude"</span>,
    LatLongDatumSRSName <span class="op">=</span> <span class="cn">NULL</span>,
    Elevation_m <span class="op">=</span> <span class="cn">NULL</span>,
    VerticalDatum <span class="op">=</span> <span class="cn">NULL</span>,
    LocalX <span class="op">=</span> <span class="cn">NULL</span>,
    LocalY <span class="op">=</span> <span class="cn">NULL</span>,
    LocalProjectionSRSName <span class="op">=</span> <span class="cn">NULL</span>,
    PosAccuracy_m <span class="op">=</span> <span class="cn">NULL</span>,
    State <span class="op">=</span> <span class="cn">NULL</span>,
    County <span class="op">=</span> <span class="cn">NULL</span>,
    Comments <span class="op">=</span> <span class="cn">NULL</span>,
    SiteType <span class="op">=</span> <span class="st">"SiteType"</span><span class="op">)</span>
  
  <span class="va">QualityControlLevels</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_quality_control.html">create_quality_control</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    QualityControlLevelCode <span class="op">=</span> <span class="st">"QualityControlLevelCode"</span>,
    Definition <span class="op">=</span> <span class="st">"Definition"</span>,
    Explanation <span class="op">=</span> <span class="st">"Explanation"</span>
  <span class="op">)</span>
  
  <span class="co"># Parse flat into hymetDP optional tables ---------------------------------</span>
  
  <span class="co"># Create the optional hymetDP tables. These are optional, but should be </span>
  <span class="co"># included if possible.</span>
  
  <span class="va">Qualifiers</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_qualifiers.html">create_qualifiers</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    QualifierCode <span class="op">=</span> <span class="st">"QualifierCode"</span>,
    QualifierDescription <span class="op">=</span> <span class="st">"QualifierDescription"</span>
  <span class="op">)</span>
  
  <span class="co"># Parse flat into the DataValues table ------------------------------------</span>
  
  <span class="co"># Create the DataValues table</span>
  
  <span class="va">DataValues</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_data_values.html">create_data_values</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    ValueID <span class="op">=</span> <span class="st">"ValueID"</span>,
    DataValue <span class="op">=</span> <span class="st">"DataValue"</span>,
    ValueAccuracy <span class="op">=</span> <span class="cn">NULL</span>,
    LocalDateTime <span class="op">=</span> <span class="st">"LocalDateTime"</span>,
    UTCOffset <span class="op">=</span> <span class="st">"UTCOffset"</span>,
    DateTimeUTC <span class="op">=</span> <span class="st">"DateTimeUTC"</span>,
    SiteCode <span class="op">=</span> <span class="st">"SiteCode"</span>,
    VariableCode <span class="op">=</span> <span class="st">"VariableCode"</span>,
    OffsetValue <span class="op">=</span> <span class="cn">NULL</span>,
    OffsetTypeCode <span class="op">=</span> <span class="cn">NULL</span>,
    CensorCode <span class="op">=</span> <span class="cn">NULL</span>,
    QualifierCode <span class="op">=</span> <span class="cn">NULL</span>,
    MethodCode <span class="op">=</span> <span class="st">"MethodCode"</span>,
    QualityControlLevelCode <span class="op">=</span> <span class="st">"QualityControlLevelCode"</span>,
    SourceCode <span class="op">=</span> <span class="st">"SourceCode"</span>,
    NoDataValue <span class="op">=</span> <span class="st">"NoDataValue"</span><span class="op">)</span>
  
  
  <span class="co"># Create the SeriesCatalog table ------------------------------------------</span>
  
  <span class="co"># Finally, create the SeriesCatalog table. This table summarizes information</span>
  <span class="co"># across several other required hymetDP tables. Since it takes the other, </span>
  <span class="co"># finalized tables as input, it must be created last.</span>
  
  <span class="va">SeriesCatalog</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_series_catalog.html">create_series_catalog</a></span><span class="op">(</span>
    Sources <span class="op">=</span> <span class="va">Sources</span>,
    Methods <span class="op">=</span> <span class="va">Methods</span>,
    Variables <span class="op">=</span> <span class="va">Variables</span>,
    Sites <span class="op">=</span> <span class="va">Sites</span>,
    QualityControlLevels <span class="op">=</span> <span class="va">QualityControlLevels</span>,
    DataValues <span class="op">=</span> <span class="va">DataValues</span><span class="op">)</span>
  
  <span class="co"># Write hymetDP tables ----------------------------------------------------</span>

  <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/write_tables.html">write_tables</a></span><span class="op">(</span>
    path <span class="op">=</span> <span class="va">path</span>,
    DataValues <span class="op">=</span> <span class="va">DataValues</span>,
    Variables <span class="op">=</span> <span class="va">Variables</span>,
    Methods <span class="op">=</span> <span class="va">Methods</span>,
    Sources <span class="op">=</span> <span class="va">Sources</span>,
    Sites <span class="op">=</span> <span class="va">Sites</span>,
    QualityControlLevels <span class="op">=</span> <span class="va">QualityControlLevels</span>,
    Qualifiers <span class="op">=</span> <span class="va">Qualifiers</span>,
    SeriesCatalog <span class="op">=</span> <span class="va">SeriesCatalog</span><span class="op">)</span>
  
  <span class="co"># Validate tables -----------------------------------------------------------</span>
  
  <span class="co"># Validation checks ensure the derived set of tables comply with the hymetDP</span>
  <span class="co"># model. Any issues at this point should be addressed in the lines of code</span>
  <span class="co"># above, the tables rewritten, and another round of validation, to be certain</span>
  <span class="co"># the fix worked.</span>

  <span class="va">issues</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/validate_data.html">validate_data</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span><span class="op">)</span>
  
  <span class="co"># Create metadata -----------------------------------------------------------</span>
  
  <span class="co"># Before publishing the derived hymetDP dataset, we need to describe it. The </span>
  <span class="co"># create_eml() function does this all for us. It knows the structure of the </span>
  <span class="co"># hymetDP model and applies standardized table descriptions and mixes in </span>
  <span class="co"># important elements of the source dataset metadata for purposes of </span>
  <span class="co"># communication and provenance tracking.</span>
  
  <span class="co"># Add contact information for the author of this script and dataset</span>

  <span class="va">additional_contact</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>
    givenName <span class="op">=</span> <span class="st">'Kyle'</span>,
    surName <span class="op">=</span> <span class="st">'Zollo-Venecek'</span>,
    organizationName <span class="op">=</span> <span class="st">'Environmental Data Initiative'</span>,
    electronicMailAddress <span class="op">=</span> <span class="st">'zollovenecek@wisc.edu'</span>,
    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

  <span class="va">eml</span> <span class="op">&lt;-</span> <span class="fu">hymetDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_eml.html">create_eml</a></span><span class="op">(</span>
    path <span class="op">=</span> <span class="va">path</span>,
    source_id <span class="op">=</span> <span class="va">source_id</span>,
    derived_id <span class="op">=</span> <span class="va">derived_id</span>,
    script <span class="op">=</span> <span class="st">"create_hymetDP.R"</span>,
    script_description <span class="op">=</span>
      <span class="st">"A function for converting knb-lter-mcm.9003 to hymetDP"</span>,
    contact <span class="op">=</span> <span class="va">additional_contact</span>,
    user_id <span class="op">=</span> <span class="st">'kzollovenecek'</span>,
    user_domain <span class="op">=</span> <span class="st">'edi'</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-function-call">Example function call:<a class="anchor" aria-label="anchor" href="#example-function-call"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Create directory for tables and metadata</span>

<span class="va">mypath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/edi_10101"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">mypath</span><span class="op">)</span>

<span class="co"># Create hymetDP dataset "edi.10101.1" from source dataset "knb-lter-mcm.9003.11"</span>

<span class="co">#&gt; create_hymetDP(</span>
<span class="co">#&gt;   path = mypath, </span>
<span class="co">#&gt;   source_id = "knb-lter-mcm.9003.11", </span>
<span class="co">#&gt;   derived_id = "edi.10101.1")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  [100%] Downloaded 11310035 bytes...</span>
<span class="co">#&gt; SourceDescription added</span>
<span class="co">#&gt; SourceLink added</span>
<span class="co">#&gt; Citation added</span>
<span class="co">#&gt; Contact Info Added</span>
<span class="co">#&gt; Writing tables to file:</span>
<span class="co">#&gt;   DataValues</span>
<span class="co">#&gt;   Variables</span>
<span class="co">#&gt;   Methods</span>
<span class="co">#&gt;   Sources</span>
<span class="co">#&gt;   Sites</span>
<span class="co">#&gt;   QualityControlLevels</span>
<span class="co">#&gt;   SeriesCatalog</span>
<span class="co">#&gt;   Qualifiers</span>
<span class="co">#&gt; Validating ed_10101:</span>
<span class="co">#&gt;   Required tables</span>
<span class="co">#&gt;   Column names</span>
<span class="co">#&gt;   Required columns</span>
<span class="co">#&gt;   Column classes</span>
<span class="co">#&gt;   Datetime formats</span>
<span class="co">#&gt;   Primary keys</span>
<span class="co">#&gt;   Composite keys</span>
<span class="co">#&gt;   Referential integrity</span>
<span class="co">#&gt;   Latitude and Longitude format</span>
<span class="co">#&gt;   Latitude and Longitude range</span>
<span class="co">#&gt;   Elevation</span>
<span class="co">#&gt;   ODM Controlled Vocabulary terms</span>
<span class="co">#&gt; Creating EML for derived data package (edi.10101.1)</span>
<span class="co">#&gt; Reading EML of L0 data package knb-lter-mcm.9003.11</span>
<span class="co">#&gt; Creating EML of L1 data package edi.10101.1</span>
<span class="co">#&gt; Updating:</span>
<span class="co">#&gt; &lt;eml&gt;</span>
<span class="co">#&gt;   &lt;dataset&gt;</span>
<span class="co">#&gt;     &lt;alternateIdentifier&gt;</span>
<span class="co">#&gt;     &lt;title&gt;</span>
<span class="co">#&gt;     &lt;pubDate&gt;</span>
<span class="co">#&gt;     &lt;keywordSet&gt;</span>
<span class="co">#&gt;     &lt;contact&gt;</span>
<span class="co">#&gt;     &lt;methods&gt;</span>
<span class="co">#&gt;     &lt;dataTable&gt;</span>
<span class="co">#&gt;     &lt;otherEntity&gt;</span>
<span class="co">#&gt;     &lt;annotations&gt;</span>
<span class="co">#&gt; &lt;/eml&gt;</span>
<span class="co">#&gt; Writing EML</span>
<span class="co">#&gt; Validating EML</span>
<span class="co">#&gt;   Validation passed :)</span>
<span class="co">#&gt; Done.</span>

<span class="co"># The working directory contains a valid set of hymetDP tables and metadata, </span>
<span class="co"># which is ready for upload to EDI (or any other EML based repository) </span>
<span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">mypath</span><span class="op">)</span>
<span class="co">#&gt;  [1] "create_hymetDP.R"        </span>
<span class="co">#&gt;  [2] "DataValues.csv"          </span>
<span class="co">#&gt;  [3] "edi.10101.1.xml"         </span>
<span class="co">#&gt;  [4] "Methods.csv"             </span>
<span class="co">#&gt;  [5] "Qualifiers.csv"          </span>
<span class="co">#&gt;  [6] "QualityControlLevels.csv"</span>
<span class="co">#&gt;  [7] "SeriesCatalog.csv"       </span>
<span class="co">#&gt;  [8] "Sites.csv"               </span>
<span class="co">#&gt; [9] "Sources.csv"             </span>
<span class="co">#&gt; [10] "Variables.csv"  </span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Kyle Zollo-Venecek.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
